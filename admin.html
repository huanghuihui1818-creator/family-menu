<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ğŸ§° èœå•åå°</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;max-width:980px;margin:24px auto;padding:0 14px;line-height:1.4}
    .card{border:1px solid #e6e6e6;border-radius:16px;padding:16px;margin:12px 0;box-shadow:0 8px 18px rgba(0,0,0,.04)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    label{font-size:13px;color:#555}
    input,select,textarea{border:1px solid #ddd;border-radius:12px;padding:10px 12px;font-size:14px}
    input,select{min-width:170px}
    textarea{width:100%;min-height:320px;font-family:ui-monospace,Menlo,Consolas,monospace}
    button{padding:10px 14px;border-radius:12px;border:1px solid #ddd;background:#fff;cursor:pointer}
    button:hover{border-color:#bbb}
    .muted{color:#666;font-size:13px}
    .ok{color:#0a7a31}
    .bad{color:#b00020}
    .pill{display:inline-block;border:1px solid #eee;border-radius:999px;padding:4px 10px;font-size:12px;color:#555;background:#fafafa}
    .split{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width: 860px){ .split{grid-template-columns:1fr} }
    ul{margin:8px 0 0 18px}
    .danger{color:#b00020}
  </style>
</head>
<body>
  <h1>ğŸ§° èœå•åå°</h1>
  <p class="muted">
    è¿™ä¸ªé¡¹ç›®æ˜¯é™æ€ç«™ï¼šåå°é¡µå¯ä»¥â€œç¼–è¾‘/æ ¡éªŒ/å¤åˆ¶â€ï¼Œä½†<strong>ä¸èƒ½ç›´æ¥å†™å›æœåŠ¡å™¨</strong>ã€‚
    ä½ éœ€è¦æŠŠå¯¼å‡ºçš„ JSON ç²˜è´´å› GitHub çš„ <code>menu.json</code> å¹¶æäº¤ï¼ˆCommitï¼‰ï¼Œç½‘é¡µæ‰ä¼šå…¨å®¶åŒæ­¥æ›´æ–°ã€‚
  </p>

  <div class="card">
    <div class="row" style="justify-content:space-between">
      <div class="row">
        <button id="loadBtn">åŠ è½½å½“å‰ menu.json</button>
        <button id="validateBtn">æ ¡éªŒ JSON</button>
        <button id="copyBtn">å¤åˆ¶ JSONï¼ˆç²˜è´´å› GitHubï¼‰</button>
        <button id="downloadBtn">ä¸‹è½½ menu.json</button>
      </div>
      <a href="./index.html">â† è¿”å›æŠ½èœå•</a>
    </div>
    <p class="muted" id="msg"></p>

    <div class="split">
      <div class="card" style="margin:0">
        <h3 style="margin:0 0 8px 0">â• å¿«é€Ÿæ·»èœï¼ˆä¸éœ€è¦æ‰‹å†™ JSONï¼‰</h3>
        <p class="muted" style="margin-top:0">
          å…ˆç‚¹â€œåŠ è½½å½“å‰ menu.jsonâ€ï¼Œç³»ç»Ÿä¼šè¯†åˆ«åˆ†ç±»ã€‚ç„¶åé€‰åˆ†ç±»/ç±»å‹ï¼Œå¡«èœåå³å¯ã€‚
        </p>

        <div class="row">
          <label>åˆ†ç±»</label>
          <select id="catSel"></select>

          <label>ç±»å‹</label>
          <select id="typeSel">
            <option value="è¤">è¤</option>
            <option value="ç´ ">ç´ </option>
            <option value="æ±¤">æ±¤</option>
            <option value="ä¸»é£Ÿ">ä¸»é£Ÿ</option>
          </select>
        </div>

        <div class="row">
          <label>èœå</label>
          <input id="nameInp" placeholder="ä¾‹å¦‚ï¼šé±¼é¦™è‚‰ä¸" style="flex:1;min-width:220px" />
        </div>

        <div class="row">
          <label>æ ‡ç­¾ï¼ˆé€—å·åˆ†éš”ï¼‰</label>
          <input id="tagsInp" placeholder="ä¾‹å¦‚ï¼šä¸‹é¥­,ä¸è¾£,å¿«æ‰‹" style="flex:1;min-width:220px" />
        </div>

        <div class="row">
          <label>ç”¨æ—¶(åˆ†é’Ÿ)</label>
          <input id="timeInp" type="number" min="0" step="1" value="20" />

          <label>éš¾åº¦(0-4)</label>
          <input id="diffInp" type="number" min="0" max="4" step="1" value="2" />
        </div>

        <div class="row">
          <button id="addDishBtn">æ·»åŠ åˆ°åˆ†ç±»</button>
          <span class="pill" id="statPill">æœªåŠ è½½æ•°æ®</span>
        </div>

        <p class="muted">
          âš ï¸ æ·»åŠ åä¼šè‡ªåŠ¨å†™å…¥ä¸‹æ–¹ JSON æ–‡æœ¬æ¡†ã€‚è®°å¾—æœ€åç‚¹â€œå¤åˆ¶ JSONâ€ï¼Œç²˜è´´å› GitHub çš„ <code>menu.json</code> å¹¶ Commitã€‚
        </p>
      </div>

      <div class="card" style="margin:0">
        <h3 style="margin:0 0 8px 0">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ æˆå‘˜åå¥½ï¼ˆä¸‹ä¸€æ­¥ index ä¼šè¯»å–ç”Ÿæ•ˆï¼‰</h3>
        <p class="muted" style="margin-top:0">
          è¿™é‡Œä¿å­˜åˆ°å½“å‰è®¾å¤‡æµè§ˆå™¨ï¼ˆlocalStorageï¼‰ã€‚ä¸‹ä¸€æ­¥æˆ‘ä¼šåœ¨ index.html é‡ŒæŠŠå®ƒæ¥ä¸Šï¼šéšæœºæ—¶è‡ªåŠ¨é¿å¼€â€œä¸åƒ/è®¨åŒâ€çš„æ ‡ç­¾ã€‚
        </p>

        <div class="row">
          <label>æˆå‘˜åå­—ï¼ˆé€—å·åˆ†éš”ï¼‰</label>
          <input id="membersInp" placeholder="ä¾‹å¦‚ï¼šçˆ¸çˆ¸,å¦ˆå¦ˆ,å­©å­" style="flex:1;min-width:220px" />
        </div>

        <div class="row">
          <label>å…¨å®¶é¿é›·æ ‡ç­¾ï¼ˆé€—å·åˆ†éš”ï¼‰</label>
          <input id="avoidTagsInp" placeholder="ä¾‹å¦‚ï¼šè¾£,é¦™èœ,å†…è„" style="flex:1;min-width:220px" />
        </div>

        <div class="row">
          <label>å…¨å®¶åçˆ±æ ‡ç­¾ï¼ˆé€—å·åˆ†éš”ï¼‰</label>
          <input id="loveTagsInp" placeholder="ä¾‹å¦‚ï¼šå¿«æ‰‹,æ¸…æ·¡,ä¸‹é¥­" style="flex:1;min-width:220px" />
        </div>

        <div class="row">
          <button id="savePrefsBtn">ä¿å­˜åå¥½åˆ°æœ¬è®¾å¤‡</button>
          <button id="clearPrefsBtn" class="danger">æ¸…ç©ºåå¥½</button>
          <span class="pill" id="prefsPill">æœªä¿å­˜</span>
        </div>

        <hr style="border:none;border-top:1px solid #eee;margin:14px 0;">

        <h3 style="margin:0 0 8px 0">ğŸ¥¬ å¯ç”¨é£Ÿæï¼ˆä¸‹ä¸€æ­¥ index ä¼šè¯»å–ç”Ÿæ•ˆï¼‰</h3>
        <p class="muted" style="margin-top:0">
          ç›®å‰æˆ‘ä»¬å…ˆåšâ€œæ‰‹åŠ¨è¾“å…¥é£Ÿæåˆ—è¡¨â€ã€‚ä¸‹ä¸€æ­¥ index.html ä¼šæ”¯æŒï¼šå‹¾é€‰/è¾“å…¥é£Ÿæåï¼Œä¼˜å…ˆæ¨èåŒ…å«ç›¸å…³æ ‡ç­¾çš„èœï¼ˆä½ ä¹Ÿå¯ä»¥åé¢æ‰©å±•æˆ ingredients å­—æ®µï¼‰ã€‚
        </p>

        <div class="row">
          <label>å†°ç®±é‡Œæœ‰ï¼ˆé€—å·åˆ†éš”ï¼‰</label>
          <input id="pantryInp" placeholder="ä¾‹å¦‚ï¼šé¸¡è›‹,ç•ªèŒ„,åœŸè±†,è±†è…" style="flex:1;min-width:220px" />
        </div>

        <div class="row">
          <button id="savePantryBtn">ä¿å­˜é£Ÿæåˆ°æœ¬è®¾å¤‡</button>
          <button id="clearPantryBtn" class="danger">æ¸…ç©ºé£Ÿæ</button>
          <span class="pill" id="pantryPill">æœªä¿å­˜</span>
        </div>
      </div>
    </div>

    <hr style="border:none;border-top:1px solid #eee;margin:14px 0;">

    <h3 style="margin:0 0 8px 0">menu.jsonï¼ˆå¯ç›´æ¥ç¼–è¾‘ï¼‰</h3>
    <textarea id="ta" placeholder="ç‚¹â€œåŠ è½½å½“å‰ menu.jsonâ€åä¼šæ˜¾ç¤ºå†…å®¹"></textarea>

    <p class="muted">
      å°æŠ€å·§ï¼šä½ å¯ä»¥åœ¨è¿™é‡Œç›´æ¥æ”¹å®Œ JSONï¼Œå†ç‚¹â€œæ ¡éªŒ JSONâ€ç¡®è®¤æ²¡é—®é¢˜ã€‚
    </p>
  </div>

<script>
const $ = (id)=>document.getElementById(id);
const MENU_KEY_PREFS = "family_menu_prefs_v1";
const MENU_KEY_PANTRY = "family_menu_pantry_v1";

let data = null;

function setMsg(text, ok=true){
  $("msg").className = ok ? "muted ok" : "muted bad";
  $("msg").textContent = text;
}

function safeParseJSON(txt){
  try { return { ok:true, value: JSON.parse(txt) }; }
  catch(e){ return { ok:false, error: e }; }
}

function normalizeCSV(s){
  return (s||"")
    .split(",")
    .map(x=>x.trim())
    .filter(Boolean);
}

function refreshCategorySelect(){
  const sel = $("catSel");
  sel.innerHTML = "";
  if(!data?.categories?.length){
    const opt = document.createElement("option");
    opt.value = "";
    opt.textContent = "ï¼ˆæœªåŠ è½½/æ— åˆ†ç±»ï¼‰";
    sel.appendChild(opt);
    $("statPill").textContent = "æœªåŠ è½½æ•°æ®";
    return;
  }
  data.categories.forEach(c=>{
    const opt = document.createElement("option");
    opt.value = c.id;
    opt.textContent = `${c.name}ï¼ˆ${c.items?.length||0}ï¼‰`;
    sel.appendChild(opt);
  });
  const first = data.categories[0];
  $("statPill").textContent = `å·²åŠ è½½ï¼š${data.categories.length} ä¸ªåˆ†ç±»`;
  // é»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ª
  sel.value = first.id;
}

function syncTextarea(){
  $("ta").value = JSON.stringify(data, null, 2);
}

async function loadMenu(){
  const r = await fetch("./menu.json?v=" + Date.now());
  const txt = await r.text();
  $("ta").value = txt;
  const parsed = safeParseJSON(txt);
  if(!parsed.ok){
    setMsg("âŒ menu.json ä¸æ˜¯åˆæ³• JSONï¼š" + parsed.error.message, false);
    data = null;
    refreshCategorySelect();
    return;
  }
  data = parsed.value;
  // ç»“æ„å…œåº•
  if(!Array.isArray(data.categories)) data.categories = [];
  data.categories.forEach(c=>{
    if(!Array.isArray(c.items)) c.items = [];
  });
  refreshCategorySelect();
  setMsg("âœ… å·²åŠ è½½å½“å‰ menu.jsonï¼ˆå¯ä»¥å¼€å§‹æ·»èœäº†ï¼‰");
}

$("loadBtn").onclick = loadMenu;

$("validateBtn").onclick = ()=>{
  const parsed = safeParseJSON($("ta").value);
  if(!parsed.ok){
    setMsg("âŒ JSON æœ‰é—®é¢˜ï¼š" + parsed.error.message, false);
    return;
  }
  setMsg("âœ… JSON æ ¡éªŒé€šè¿‡");
  // åŒæ­¥ dataï¼Œå¹¶åˆ·æ–°åˆ†ç±»åˆ—è¡¨
  data = parsed.value;
  if(!Array.isArray(data.categories)) data.categories = [];
  data.categories.forEach(c=>{
    if(!Array.isArray(c.items)) c.items = [];
  });
  refreshCategorySelect();
};

$("addDishBtn").onclick = ()=>{
  if(!data){
    setMsg("å…ˆç‚¹â€œåŠ è½½å½“å‰ menu.jsonâ€", false);
    return;
  }
  const catId = $("catSel").value;
  const type = $("typeSel").value;
  const name = ($("nameInp").value||"").trim();
  if(!catId){
    setMsg("æ²¡æœ‰å¯ç”¨åˆ†ç±»ï¼šè¯·å…ˆåœ¨ menu.json é‡Œé…ç½® categories", false);
    return;
  }
  if(!name){
    setMsg("èœåä¸èƒ½ä¸ºç©º", false);
    return;
  }
  const time = Number($("timeInp").value||0);
  const difficulty = Number($("diffInp").value||0);
  const tags = normalizeCSV($("tagsInp").value);

  const cat = data.categories.find(c=>c.id===catId);
  if(!cat){
    setMsg("æ‰¾ä¸åˆ°åˆ†ç±»ï¼ˆå¯èƒ½ JSON ç»“æ„æœ‰é—®é¢˜ï¼‰", false);
    return;
  }

  // å»é‡ï¼šåŒåˆ†ç±»åŒåä¸é‡å¤
  if(cat.items.some(x => (x.name||"").trim() === name)){
    setMsg("è¿™ä¸ªåˆ†ç±»é‡Œå·²ç»æœ‰åŒåèœäº†ï¼ˆé¿å…é‡å¤ï¼‰", false);
    return;
  }

  const item = {
    name,
    type,
    tags,
    time: Number.isFinite(time) ? time : 0,
    difficulty: Number.isFinite(difficulty) ? difficulty : 0
  };
  cat.items.push(item);

  // åŒæ­¥åˆ° textarea
  syncTextarea();
  refreshCategorySelect();

  // æ¸…ç©ºè¾“å…¥
  $("nameInp").value = "";
  $("tagsInp").value = "";
  setMsg(`âœ… å·²æ·»åŠ ï¼š${cat.name} / ${type} / ${item.name}ï¼ˆè®°å¾—å¤åˆ¶ JSON ç²˜è´´å› GitHub å¹¶ Commitï¼‰`);
};

$("copyBtn").onclick = async ()=>{
  const parsed = safeParseJSON($("ta").value);
  if(!parsed.ok){
    setMsg("âŒ ä¸èƒ½å¤åˆ¶ï¼šJSON ä¸åˆæ³•ï¼š" + parsed.error.message, false);
    return;
  }
  const pretty = JSON.stringify(parsed.value, null, 2);
  try{
    await navigator.clipboard.writeText(pretty);
    setMsg("âœ… å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼šå» GitHub æ‰“å¼€ menu.json â†’ ç²˜è´´è¦†ç›– â†’ Commit changes");
  }catch(e){
    setMsg("âŒ å¤åˆ¶å¤±è´¥ï¼ˆæµè§ˆå™¨æƒé™é™åˆ¶ï¼‰ï¼Œè¯·æ‰‹åŠ¨å…¨é€‰æ–‡æœ¬æ¡†å†…å®¹å¤åˆ¶ã€‚", false);
  }
};

$("downloadBtn").onclick = ()=>{
  const parsed = safeParseJSON($("ta").value);
  if(!parsed.ok){
    setMsg("âŒ ä¸èƒ½ä¸‹è½½ï¼šJSON ä¸åˆæ³•ï¼š" + parsed.error.message, false);
    return;
  }
  const pretty = JSON.stringify(parsed.value, null, 2);
  const blob = new Blob([pretty], {type:"application/json;charset=utf-8"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "menu.json";
  document.body.appendChild(a);
  a.click();
  a.remove();
  setMsg("âœ… å·²ä¸‹è½½ menu.jsonï¼ˆä»éœ€ç²˜è´´å› GitHub æ‰ä¼šè®©ç«™ç‚¹åŒæ­¥æ›´æ–°ï¼‰");
};

// ---------- åå¥½/é£Ÿæï¼šå­˜åˆ° localStorageï¼Œä¸‹ä¸€æ­¥ index.html ä¼šè¯»å– ----------
function loadPrefsUI(){
  const raw = localStorage.getItem(MENU_KEY_PREFS);
  if(!raw){
    $("prefsPill").textContent = "æœªä¿å­˜";
    return;
  }
  try{
    const obj = JSON.parse(raw);
    $("membersInp").value = (obj.members||[]).join(",");
    $("avoidTagsInp").value = (obj.avoid_tags||[]).join(",");
    $("loveTagsInp").value = (obj.love_tags||[]).join(",");
    $("prefsPill").textContent = "å·²ä»æœ¬è®¾å¤‡è½½å…¥";
  }catch{
    $("prefsPill").textContent = "è¯»å–å¤±è´¥";
  }
}

$("savePrefsBtn").onclick = ()=>{
  const obj = {
    members: normalizeCSV($("membersInp").value),
    avoid_tags: normalizeCSV($("avoidTagsInp").value),
    love_tags: normalizeCSV($("loveTagsInp").value)
  };
  localStorage.setItem(MENU_KEY_PREFS, JSON.stringify(obj));
  $("prefsPill").textContent = "âœ… å·²ä¿å­˜";
  setMsg("âœ… åå¥½å·²ä¿å­˜åˆ°æœ¬è®¾å¤‡ï¼ˆä¸‹ä¸€æ­¥ index ä¼šè¯»å–å¹¶ç”Ÿæ•ˆï¼‰");
};

$("clearPrefsBtn").onclick = ()=>{
  localStorage.removeItem(MENU_KEY_PREFS);
  $("membersInp").value = "";
  $("avoidTagsInp").value = "";
  $("loveTagsInp").value = "";
  $("prefsPill").textContent = "å·²æ¸…ç©º";
  setMsg("âœ… å·²æ¸…ç©ºåå¥½ï¼ˆæœ¬è®¾å¤‡ï¼‰");
};

function loadPantryUI(){
  const raw = localStorage.getItem(MENU_KEY_PANTRY);
  if(!raw){
    $("pantryPill").textContent = "æœªä¿å­˜";
    return;
  }
  try{
    const obj = JSON.parse(raw);
    $("pantryInp").value = (obj.items||[]).join(",");
    $("pantryPill").textContent = "å·²ä»æœ¬è®¾å¤‡è½½å…¥";
  }catch{
    $("pantryPill").textContent = "è¯»å–å¤±è´¥";
  }
}

$("savePantryBtn").onclick = ()=>{
  const obj = { items: normalizeCSV($("pantryInp").value) };
  localStorage.setItem(MENU_KEY_PANTRY, JSON.stringify(obj));
  $("pantryPill").textContent = "âœ… å·²ä¿å­˜";
  setMsg("âœ… é£Ÿæå·²ä¿å­˜åˆ°æœ¬è®¾å¤‡ï¼ˆä¸‹ä¸€æ­¥ index ä¼šè¯»å–å¹¶ç”Ÿæ•ˆï¼‰");
};

$("clearPantryBtn").onclick = ()=>{
  localStorage.removeItem(MENU_KEY_PANTRY);
  $("pantryInp").value = "";
  $("pantryPill").textContent = "å·²æ¸…ç©º";
  setMsg("âœ… å·²æ¸…ç©ºé£Ÿæï¼ˆæœ¬è®¾å¤‡ï¼‰");
};

// åˆå§‹è½½å…¥åå¥½/é£Ÿæ UI
loadPrefsUI();
loadPantryUI();
</script>
</body>
</html>
