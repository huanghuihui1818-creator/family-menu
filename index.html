<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ğŸ½ï¸ ä»Šå¤©åƒä»€ä¹ˆ</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;max-width:980px;margin:24px auto;padding:0 14px;line-height:1.4}
    h1{margin:6px 0 10px}
    .muted{color:#666;font-size:13px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    button{padding:10px 14px;border-radius:14px;border:1px solid #ddd;background:#fff;cursor:pointer}
    button.primary{background:#111;color:#fff;border-color:#111}
    button:hover{border-color:#999}
    button[disabled]{opacity:.45}
    input{border:1px solid #ddd;border-radius:12px;padding:10px 12px;font-size:14px}
    .card{border:1px solid #e6e6e6;border-radius:18px;padding:16px;margin:12px 0;box-shadow:0 10px 22px rgba(0,0,0,.04)}
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{padding:8px 12px;border-radius:999px;border:1px solid #e6e6e6;cursor:pointer}
    .chip.active{background:#111;color:#fff;border-color:#111}
    .tag{display:inline-block;border:1px solid #eee;border-radius:999px;padding:4px 10px;font-size:12px;margin-right:6px;margin-top:6px}
    .big{font-size:22px;font-weight:700}
    .shake{animation:shake .35s}
    @keyframes shake{0%{transform:translateX(0)}25%{transform:translateX(-6px)}50%{transform:translateX(6px)}75%{transform:translateX(-4px)}100%{transform:translateX(0)}}
    ul{margin:8px 0 0 18px}
    .pill{display:inline-block;border:1px solid #eee;border-radius:999px;padding:4px 10px;font-size:12px;background:#fafafa}
    .danger{color:#b00020}
  </style>
</head>
<body>

<div class="row" style="justify-content:space-between">
  <h1>ğŸ½ï¸ ä»Šå¤©åƒä»€ä¹ˆ</h1>
  <a href="./admin.html">åå°åŠ èœ â†’</a>
</div>

<p class="muted" id="status">åŠ è½½ä¸­â€¦</p>

<!-- åˆ†ç±»é€‰æ‹© -->
<div class="card">
  <h3>é€‰æ‹©åˆ†ç±»</h3>
  <div class="chips" id="cats"></div>
</div>

<!-- å¯ç”¨é£Ÿæï¼ˆç½‘é¡µç«¯ï¼‰ -->
<div class="card">
  <h3>ğŸ¥¬ å¯ç”¨é£Ÿæï¼ˆå½±å“æ¨èï¼‰</h3>
  <p class="muted">è¾“å…¥ä½ ç°åœ¨èƒ½ç”¨çš„é£Ÿæï¼ŒåŒ¹é…çš„èœä¼šæ›´å®¹æ˜“è¢«é€‰ä¸­</p>
  <div class="row">
    <input id="pantryInput" placeholder="å¦‚ï¼šé¸¡è›‹,ç•ªèŒ„,åœŸè±†,è±†è…" style="flex:1;min-width:240px">
    <button id="savePantryBtn">ä¿å­˜</button>
    <button id="clearPantryBtn">æ¸…ç©º</button>
    <span class="pill" id="pantryHint">æœªè®¾ç½®</span>
  </div>
</div>

<!-- æŠ½èœå• -->
<div class="card">
  <div class="row">
    <button class="primary" id="rollBtn">ğŸ¡ å•èœ</button>
    <button id="mealBtn">ğŸ± ä¸€è¤ä¸€ç´ ä¸€æ±¤</button>
    <button id="rerollBtn" disabled>ä¸æœå†æ¥ä¸€æ¬¡</button>
    <button id="resetBtn">é‡ç½®</button>
  </div>

  <div id="resultCard" class="card" style="display:none;margin-top:14px">
    <div class="muted" id="resultMeta"></div>
    <div class="big" id="resultName"></div>
    <div id="resultTags"></div>
    <div class="row" style="margin-top:12px">
      <button class="primary" id="confirmBtn">âœ… å°±åƒå®ƒ</button>
      <button id="cancelBtn">åªæ˜¯çœ‹çœ‹</button>
      <span class="muted" id="confirmHint"></span>
    </div>
  </div>
</div>

<!-- æœ€è¿‘åƒè¿‡ -->
<div class="card">
  <h3>æœ€è¿‘åƒè¿‡ï¼ˆç¡®è®¤åæ‰è®°å½•ï¼‰</h3>
  <ul id="recentList"></ul>
  <button class="danger" id="clearRecentBtn">æ¸…ç©ºè®°å½•</button>
</div>

<script>
const $ = id => document.getElementById(id);

const KEY_PANTRY = "family_menu_pantry_v1";
const KEY_PREFS  = "family_menu_prefs_v1";
const KEY_RECENT = "family_menu_recent_v2";

let data=null, currentCatId=null, rerollCount=0, pending=null;

/* ---------- æœ¬åœ°æ•°æ® ---------- */
const loadPantry = ()=>{ try{ return JSON.parse(localStorage.getItem(KEY_PANTRY))||{items:[]} }catch{return{items:[]}} };
const savePantry = arr => localStorage.setItem(KEY_PANTRY, JSON.stringify({items:arr}));
const loadPrefs = ()=>{ try{ return JSON.parse(localStorage.getItem(KEY_PREFS))||{} }catch{return{}} };
const loadRecent = ()=>{ try{ return JSON.parse(localStorage.getItem(KEY_RECENT))||[] }catch{return[]} };
const saveRecent = arr => localStorage.setItem(KEY_RECENT, JSON.stringify(arr));

/* ---------- åˆå§‹åŒ–å¯ç”¨é£Ÿæ UI ---------- */
function initPantryUI(){
  const p = loadPantry().items||[];
  $("pantryInput").value = p.join(",");
  $("pantryHint").textContent = p.length ? "å·²è®¾ç½®" : "æœªè®¾ç½®";
}
$("savePantryBtn").onclick = ()=>{
  const items = $("pantryInput").value.split(",").map(x=>x.trim()).filter(Boolean);
  savePantry(items);
  $("pantryHint").textContent = items.length ? "å·²ä¿å­˜" : "æœªè®¾ç½®";
};
$("clearPantryBtn").onclick = ()=>{
  savePantry([]);
  $("pantryInput").value="";
  $("pantryHint").textContent="å·²æ¸…ç©º";
};

/* ---------- éšæœºé€»è¾‘ ---------- */
function weightedPick(items){
  const prefs = loadPrefs();
  const pantry = loadPantry().items||[];
  const recentSet = new Set(loadRecent().map(x=>x.name));

  const pool = items.filter(it=>{
    if((prefs.avoid_tags||[]).some(t=>it.tags?.includes(t))) return false;
    if(recentSet.has(it.name)) return false;
    return true;
  });

  if(!pool.length) return null;

  const weights = pool.map(it=>{
    let w = 1;
    (prefs.love_tags||[]).forEach(t=>{ if(it.tags?.includes(t)) w+=3; });
    pantry.forEach(f=>{
      if(it.name.includes(f) || it.tags?.includes(f)) w+=2;
    });
    return w;
  });

  let r = Math.random()*weights.reduce((a,b)=>a+b,0);
  for(let i=0;i<pool.length;i++){ if((r-=weights[i])<=0) return pool[i]; }
  return pool[pool.length-1];
}

/* ---------- æ¸²æŸ“ ---------- */
function showResult(meta,name,tags){
  $("resultCard").style.display="block";
  $("resultMeta").textContent=meta;
  $("resultName").textContent=name;
  $("resultTags").innerHTML=(tags||[]).map(t=>`<span class="tag">${t}</span>`).join("");
  $("resultCard").classList.remove("shake"); void $("resultCard").offsetWidth; $("resultCard").classList.add("shake");
}

/* ---------- å•èœ ---------- */
function rollSingle(){
  const cat = data.categories.find(c=>c.id===currentCatId);
  const pick = weightedPick(cat.items);
  if(!pick){ alert("æ²¡æœ‰å¯é€‰èœäº†"); return; }
  pending=[pick];
  showResult(`å•èœï½œ${cat.name}`, pick.name, pick.tags);
  $("rerollBtn").disabled=false;
}

/* ---------- å¥—é¤ ---------- */
function rollMeal(){
  const m=data.categories.find(c=>c.id==="meat")||{};
  const v=data.categories.find(c=>c.id==="veg")||{};
  const s=data.categories.find(c=>c.id==="soup")||{};
  if(!m.items||!v.items||!s.items){ alert("éœ€è¦è¤/ç´ /æ±¤åˆ†ç±»"); return; }
  const a=weightedPick(m.items), b=weightedPick(v.items), c=weightedPick(s.items);
  if(!a||!b||!c){ alert("å¥—é¤æŠ½å–å¤±è´¥"); return; }
  pending=[a,b,c];
  showResult("ä¸€è¤ä¸€ç´ ä¸€æ±¤", `è¤ï¼š${a.name} Â· ç´ ï¼š${b.name} Â· æ±¤ï¼š${c.name}`, [...new Set([...a.tags,...b.tags,...c.tags])]);
  $("rerollBtn").disabled=false;
}

/* ---------- ç¡®è®¤ ---------- */
$("confirmBtn").onclick=()=>{
  const rec=loadRecent();
  pending.forEach(it=>rec.push({name:it.name,date:new Date().toISOString()}));
  saveRecent(rec);
  renderRecent();
  $("confirmHint").textContent="å·²è®°å½•ï¼Œä¸‹æ¬¡ä¼šé¿å¼€";
};

/* ---------- æœ€è¿‘ ---------- */
function renderRecent(){
  const ul=$("recentList"); ul.innerHTML="";
  loadRecent().slice(-20).reverse().forEach(x=>{
    const li=document.createElement("li");
    li.textContent=x.name;
    ul.appendChild(li);
  });
}
$("clearRecentBtn").onclick=()=>{ saveRecent([]); renderRecent(); };

/* ---------- äº‹ä»¶ ---------- */
$("rollBtn").onclick=()=>{ rerollCount=0; rollSingle(); };
$("mealBtn").onclick=()=>{ rerollCount=0; rollMeal(); };
$("rerollBtn").onclick=()=>{ pending.length===1?rollSingle():rollMeal(); };
$("resetBtn").onclick=()=>{ pending=null; $("resultCard").style.display="none"; $("rerollBtn").disabled=true; };
$("cancelBtn").onclick=()=>{ $("confirmHint").textContent="æœªè®°å½•"; };

/* ---------- åˆå§‹åŒ– ---------- */
fetch("./menu.json?v="+Date.now())
  .then(r=>r.json())
  .then(j=>{
    data=j;
    $("status").textContent="èœå•å·²åŠ è½½";
    const cats=$("cats");
    j.categories.forEach((c,i)=>{
      const d=document.createElement("div");
      d.className="chip"+(i===0?" active":"");
      d.textContent=c.name;
      d.onclick=()=>{ currentCatId=c.id; [...cats.children].forEach(x=>x.classList.remove("active")); d.classList.add("active"); };
      cats.appendChild(d);
      if(i===0) currentCatId=c.id;
    });
  });

initPantryUI();
renderRecent();
</script>
</body>
</html>
