<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ğŸ½ï¸ å®¶åº­éšæœºèœå•</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;max-width:980px;margin:24px auto;padding:0 14px;line-height:1.4}
    h1{margin:6px 0 10px 0}
    .muted{color:#666;font-size:13px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    button{padding:10px 14px;border-radius:14px;border:1px solid #ddd;background:#fff;cursor:pointer}
    button:hover{border-color:#bbb}
    button.primary{border-color:#111;background:#111;color:#fff}
    button[disabled]{opacity:.45;cursor:not-allowed}
    .chips{display:flex;flex-wrap:wrap;gap:8px}
    .chip{padding:8px 12px;border-radius:999px;border:1px solid #e6e6e6;background:#fafafa;cursor:pointer}
    .chip.active{border-color:#111;background:#111;color:#fff}
    .card{border:1px solid #e6e6e6;border-radius:18px;padding:16px;margin:12px 0;box-shadow:0 10px 22px rgba(0,0,0,.04)}
    .tag{display:inline-block;border:1px solid #eee;border-radius:999px;padding:4px 10px;font-size:12px;color:#555;background:#fafafa;margin-right:6px;margin-top:6px}
    .big{font-size:22px;font-weight:700}
    .shake{animation:shake .38s}
    @keyframes shake{
      0%{transform:translateX(0)}
      25%{transform:translateX(-6px)}
      50%{transform:translateX(6px)}
      75%{transform:translateX(-4px)}
      100%{transform:translateX(0)}
    }
    .split{display:grid;grid-template-columns:1.2fr .8fr;gap:12px}
    @media (max-width:860px){.split{grid-template-columns:1fr}}
    .list{margin:8px 0 0 18px}
    .pill{display:inline-block;border:1px solid #eee;border-radius:999px;padding:4px 10px;font-size:12px;color:#555;background:#fafafa}
    .danger{color:#b00020}
  </style>
</head>
<body>
  <div class="row" style="justify-content:space-between">
    <h1>ğŸ½ï¸ ä»Šå¤©åƒä»€ä¹ˆ</h1>
    <a href="./admin.html">åå°åŠ èœ â†’</a>
  </div>

  <p class="muted" id="status">æ­£åœ¨åŠ è½½èœå•åº“â€¦</p>

  <div class="card">
    <h3 style="margin:0 0 10px 0">é€‰æ‹©åˆ†ç±»</h3>
    <div class="chips" id="cats"></div>
    <p class="muted" style="margin:10px 0 0 0">
      æç¤ºï¼šå¦‚æœä½ å·²ç»æŒ‰â€œè¤èœ / ç´ èœ / æ±¤ / ä¸»é£Ÿâ€åˆ†å¥½ç±»ï¼Œé‚£ä¹ˆâ€œä¸€è¤ä¸€ç´ ä¸€æ±¤â€ä¼šè‡ªåŠ¨ä»å¯¹åº”åˆ†ç±»å„æŠ½ä¸€ä»½ã€‚
    </p>
  </div>

  <div class="card">
    <div class="row" style="justify-content:space-between">
      <div class="row">
        <button id="rollBtn" class="primary">ğŸ¡ å‘½è¿ä¹‹è½®ï¼ˆå•èœï¼‰</button>
        <button id="mealBtn">ğŸ± ä¸€è¤ä¸€ç´ ä¸€æ±¤</button>
        <button id="rerollBtn" disabled>ä¸æœå†æ¥ä¸€æ¬¡</button>
        <button id="resetBtn">é‡ç½®é‡é€‰æ¬¡æ•°</button>
      </div>
      <div class="row">
        <span class="pill" id="prefsHint">åå¥½ï¼šæœªè®¾ç½®</span>
        <span class="pill" id="pantryHint">é£Ÿæï¼šæœªè®¾ç½®</span>
      </div>
    </div>

    <div id="resultCard" class="card" style="display:none;margin-top:14px">
      <div class="muted" id="resultMeta"></div>
      <div class="big" id="resultName" style="margin:8px 0 6px 0"></div>
      <div id="resultTags"></div>

      <div class="row" style="margin-top:12px">
        <button id="confirmBtn" class="primary">âœ… å°±åƒå®ƒï¼ˆè®°å…¥æœ€è¿‘åƒè¿‡ï¼‰</button>
        <button id="cancelBtn">å…ˆä¸è®°ï¼ˆåªæ˜¯çœ‹çœ‹ï¼‰</button>
        <span class="muted" id="confirmHint"></span>
      </div>
    </div>
  </div>

  <div class="split">
    <div class="card">
      <h3 style="margin:0 0 8px 0">æœ€è¿‘åƒè¿‡ï¼ˆä»…åœ¨ä½ ç‚¹â€œâœ… å°±åƒå®ƒâ€åè®°å½•ï¼‰</h3>
      <p class="muted" style="margin-top:0">
        é»˜è®¤ä¼šå°½é‡é¿å¼€<strong>æœ€è¿‘ 7 å¤©</strong>å·²ç»ç¡®è®¤åƒè¿‡çš„èœã€‚
      </p>
      <ul class="list" id="recentList"></ul>
      <div class="row" style="margin-top:10px">
        <button id="clearRecentBtn" class="danger">æ¸…ç©ºæœ€è¿‘åƒè¿‡ï¼ˆæœ¬è®¾å¤‡ï¼‰</button>
        <span class="muted">åªæ¸…å½“å‰è®¾å¤‡æµè§ˆå™¨ï¼Œä¸å½±å“ GitHub èœå•åº“</span>
      </div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 8px 0">å°æç¤º</h3>
      <ul class="list">
        <li>æˆå‘˜åå¥½/é£Ÿæåœ¨ <code>admin.html</code> ä¿å­˜åˆ°æœ¬è®¾å¤‡ï¼ˆlocalStorageï¼‰ï¼ŒåŒä¸€å°è®¾å¤‡ä¼šç”Ÿæ•ˆã€‚</li>
        <li>å¦‚æœä½ å¸Œæœ›å…¨å®¶è®¾å¤‡éƒ½åŒæ­¥åå¥½/é£Ÿæï¼šåé¢å¯ä»¥å‡çº§åˆ° Firebaseï¼ˆçœŸåå°ï¼‰ã€‚</li>
      </ul>
    </div>
  </div>

<script>
const $ = (id)=>document.getElementById(id);

const KEY_PREFS  = "family_menu_prefs_v1";
const KEY_PANTRY = "family_menu_pantry_v1";
const KEY_RECENT = "family_menu_recent_v2"; // v2: [{name, date}]

const AVOID_DAYS = 7; // é»˜è®¤é¿å¼€æœ€è¿‘7å¤©ç¡®è®¤åƒè¿‡çš„

let data = null;
let currentCatId = null;
let rerollCount = 0;

// å½“å‰â€œå¾…ç¡®è®¤â€çš„å€™é€‰ï¼ˆå•èœæˆ–å¥—é¤ï¼‰
let pending = null; // { mode:"single"|"meal", items:[{name,...}], metaText, tagHTML }

function normalizeCSVtoArray(s){
  return (s||"").split(",").map(x=>x.trim()).filter(Boolean);
}

function loadPrefs(){
  try{
    const raw = localStorage.getItem(KEY_PREFS);
    if(!raw) return { members:[], avoid_tags:[], love_tags:[] };
    const o = JSON.parse(raw);
    return {
      members: Array.isArray(o.members)?o.members:[],
      avoid_tags: Array.isArray(o.avoid_tags)?o.avoid_tags:[],
      love_tags: Array.isArray(o.love_tags)?o.love_tags:[]
    };
  }catch{
    return { members:[], avoid_tags:[], love_tags:[] };
  }
}

function loadPantry(){
  try{
    const raw = localStorage.getItem(KEY_PANTRY);
    if(!raw) return { items:[] };
    const o = JSON.parse(raw);
    return { items: Array.isArray(o.items)?o.items:[] };
  }catch{
    return { items:[] };
  }
}

function loadRecent(){
  try{
    const raw = localStorage.getItem(KEY_RECENT);
    if(!raw) return [];
    const arr = JSON.parse(raw);
    return Array.isArray(arr)?arr:[];
  }catch{
    return [];
  }
}

function saveRecent(arr){
  localStorage.setItem(KEY_RECENT, JSON.stringify(arr));
}

function todayISO(){
  const d = new Date();
  return d.toISOString();
}

function withinDays(iso, days){
  const t = new Date(iso).getTime();
  if(Number.isNaN(t)) return false;
  const now = Date.now();
  return (now - t) <= days*24*60*60*1000;
}

function recentNamesSet(days=AVOID_DAYS){
  const rec = loadRecent().filter(x => x?.name && x?.date && withinDays(x.date, days));
  return new Set(rec.map(x=>x.name));
}

function renderRecent(){
  const ul = $("recentList");
  ul.innerHTML = "";
  const rec = loadRecent()
    .filter(x=>x?.name && x?.date)
    .sort((a,b)=> new Date(b.date) - new Date(a.date))
    .slice(0, 30);

  if(!rec.length){
    const li = document.createElement("li");
    li.textContent = "ï¼ˆè¿˜æ²¡æœ‰ç¡®è®¤åƒè¿‡çš„è®°å½•ï¼‰";
    ul.appendChild(li);
    return;
  }

  rec.forEach(x=>{
    const li = document.createElement("li");
    const d = new Date(x.date);
    const ds = Number.isNaN(d.getTime()) ? "" : `ï¼ˆ${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}ï¼‰`;
    li.textContent = `${x.name} ${ds}`;
    ul.appendChild(li);
  });
}

function updateHints(){
  const prefs = loadPrefs();
  const pantry = loadPantry();

  const p1 = prefs.avoid_tags?.length ? `é¿é›·ï¼š${prefs.avoid_tags.slice(0,3).join("ã€")}${prefs.avoid_tags.length>3?"â€¦":""}` : "åå¥½ï¼šæœªè®¾ç½®";
  const p2 = pantry.items?.length ? `é£Ÿæï¼š${pantry.items.slice(0,3).join("ã€")}${pantry.items.length>3?"â€¦":""}` : "é£Ÿæï¼šæœªè®¾ç½®";

  $("prefsHint").textContent = p1;
  $("pantryHint").textContent = p2;
}

function tagHTML(tags){
  return (tags||[]).map(t=>`<span class="tag">${escapeHTML(t)}</span>`).join("");
}

function escapeHTML(s){
  return String(s).replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[m]));
}

// æƒé‡ï¼šåçˆ±æ ‡ç­¾ + é£ŸæåŒ¹é…åŠ æƒï¼›é¿é›·æ ‡ç­¾ç›´æ¥è¿‡æ»¤
function scoreItem(item, prefs, pantry){
  let score = 1;

  const tags = Array.isArray(item.tags) ? item.tags : [];
  const name = (item.name||"");

  // åçˆ±åŠ æƒ
  for(const t of (prefs.love_tags||[])){
    if(tags.includes(t)) score += 3;
  }

  // é£ŸæåŠ æƒï¼šé£Ÿæå‡ºç°åœ¨èœå æˆ– tags é‡Œï¼ˆä½ ä¹Ÿå¯ä»¥åç»­æŠŠé£Ÿæå†™è¿› tagsï¼‰
  for(const ing of (pantry.items||[])){
    if(!ing) continue;
    if(name.includes(ing)) score += 2;
    if(tags.includes(ing)) score += 2;
  }

  // å¿«æ‰‹/æ¸…æ·¡ç­‰å¸¸ç”¨æ ‡ç­¾è½»å¾®åŠ æƒï¼ˆè®©ä½“éªŒæ›´â€œå®¶ç”¨â€ï¼‰
  if(tags.includes("å¿«æ‰‹")) score += 0.5;

  return score;
}

function passesAvoid(item, prefs){
  const avoid = prefs.avoid_tags || [];
  if(!avoid.length) return true;
  const tags = Array.isArray(item.tags) ? item.tags : [];
  for(const t of avoid){
    if(tags.includes(t)) return false;
  }
  return true;
}

function weightedPick(items, prefs, pantry, avoidRecentSet){
  // å…ˆè¿‡æ»¤é¿é›·
  let pool = items.filter(it => passesAvoid(it, prefs));

  // å°½é‡é¿å¼€æœ€è¿‘åƒè¿‡
  let poolNoRecent = pool.filter(it => !avoidRecentSet.has(it.name));
  if(poolNoRecent.length) pool = poolNoRecent; // æœ‰å¯ç”¨å°±ç”¨â€œé¿å¼€æœ€è¿‘â€çš„ç‰ˆæœ¬

  if(!pool.length) return null;

  // æƒé‡éšæœº
  const weights = pool.map(it => scoreItem(it, prefs, pantry));
  const total = weights.reduce((a,b)=>a+b,0);
  let r = Math.random() * total;
  for(let i=0;i<pool.length;i++){
    r -= weights[i];
    if(r <= 0) return pool[i];
  }
  return pool[pool.length-1];
}

function findCategoryByNameOrId(idOrName){
  if(!data?.categories?.length) return null;
  return data.categories.find(c => c.id===idOrName || c.name===idOrName) || null;
}

function renderCategories(){
  const wrap = $("cats");
  wrap.innerHTML = "";
  if(!data?.categories?.length){
    wrap.textContent = "ï¼ˆèœå•åº“é‡Œæ²¡æœ‰ categoriesï¼Œè¯·æ£€æŸ¥ menu.jsonï¼‰";
    return;
  }

  data.categories.forEach(c=>{
    const b = document.createElement("div");
    b.className = "chip";
    b.textContent = `${c.name}`;
    b.onclick = ()=>{
      currentCatId = c.id;
      [...wrap.children].forEach(x=>x.classList.remove("active"));
      b.classList.add("active");
      rerollCount = 0;
      $("rerollBtn").disabled = true;
      hideResult();
    };
    wrap.appendChild(b);
  });

  // é»˜è®¤é€‰ç¬¬ä¸€ä¸ª
  currentCatId = data.categories[0].id;
  wrap.children[0].classList.add("active");
}

function showResultCard(metaText, titleText, tags){
  $("resultCard").style.display = "block";
  $("resultMeta").textContent = metaText;
  $("resultName").textContent = titleText;
  $("resultTags").innerHTML = tagHTML(tags);

  $("resultCard").classList.remove("shake");
  void $("resultCard").offsetWidth;
  $("resultCard").classList.add("shake");
}

function hideResult(){
  $("resultCard").style.display = "none";
  pending = null;
  $("confirmHint").textContent = "";
}

function rollSingle(){
  if(!currentCatId){
    alert("å…ˆé€‰ä¸ªåˆ†ç±»ï½");
    return;
  }
  const cat = data.categories.find(c=>c.id===currentCatId);
  const items = cat?.items || [];
  if(!items.length){
    alert("è¿™ä¸ªåˆ†ç±»è¿˜æ²¡èœï¼Œå»åå°åŠ ç‚¹å§ï½");
    return;
  }

  const prefs = loadPrefs();
  const pantry = loadPantry();
  const avoidRecentSet = recentNamesSet(AVOID_DAYS);

  const pick = weightedPick(items, prefs, pantry, avoidRecentSet);
  if(!pick){
    alert("ç­›é€‰åæ²¡æœ‰å¯é€‰èœï¼ˆå¯èƒ½é¿é›·æ ‡ç­¾å¤ªå¤šï¼‰ã€‚å»åå°æŠŠâ€œå…¨å®¶é¿é›·æ ‡ç­¾â€æ”¹å°‘ä¸€ç‚¹è¯•è¯•ã€‚");
    return;
  }

  const meta = `æ¨¡å¼ï¼šå•èœï½œåˆ†ç±»ï¼š${cat.name}ï½œé‡é€‰ï¼š${rerollCount} æ¬¡`;
  showResultCard(meta, pick.name, pick.tags||[]);

  pending = {
    mode: "single",
    items: [pick],
    metaText: meta
  };

  $("rerollBtn").disabled = false;
  $("confirmHint").textContent = "ç‚¹ âœ… æ‰ä¼šè®°å…¥â€œæœ€è¿‘åƒè¿‡â€";
}

function rollMeal(){
  const prefs = loadPrefs();
  const pantry = loadPantry();
  const avoidRecentSet = recentNamesSet(AVOID_DAYS);

  // ä¼˜å…ˆï¼šå¦‚æœå­˜åœ¨â€œè¤èœ/ç´ èœ/æ±¤â€ä¸‰ä¸ªåˆ†ç±»ï¼Œå°±ä»ä¸‰ä¸ªåˆ†ç±»å„æŠ½ä¸€ä»½
  const catMeat = findCategoryByNameOrId("meat") || findCategoryByNameOrId("è¤èœ");
  const catVeg  = findCategoryByNameOrId("veg")  || findCategoryByNameOrId("ç´ èœ");
  const catSoup = findCategoryByNameOrId("soup") || findCategoryByNameOrId("æ±¤");

  let meat = null, veg = null, soup = null;
  let metaCatText = "";

  if(catMeat?.items?.length && catVeg?.items?.length && catSoup?.items?.length){
    meat = weightedPick(catMeat.items, prefs, pantry, avoidRecentSet);
    veg  = weightedPick(catVeg.items,  prefs, pantry, avoidRecentSet);
    soup = weightedPick(catSoup.items, prefs, pantry, avoidRecentSet);
    metaCatText = `æ¥æºï¼š${catMeat.name} + ${catVeg.name} + ${catSoup.name}`;
  }else{
    // å…œåº•ï¼šä»å½“å‰åˆ†ç±»é‡ŒæŒ‰ type=è¤/ç´ /æ±¤ è¿‡æ»¤æŠ½
    if(!currentCatId){
      alert("å…ˆé€‰ä¸ªåˆ†ç±»ï½");
      return;
    }
    const cat = data.categories.find(c=>c.id===currentCatId);
    const items = cat?.items || [];
    if(!items.length){
      alert("è¿™ä¸ªåˆ†ç±»è¿˜æ²¡èœï¼Œå»åå°åŠ ç‚¹å§ï½");
      return;
    }
    const byType = (t)=> items.filter(x => (x.type||"")===t);
    if(!byType("è¤").length || !byType("ç´ ").length || !byType("æ±¤").length){
      alert("å¥—é¤æ¨¡å¼éœ€è¦ï¼šè¦ä¹ˆèœå•é‡Œæœ‰åˆ†ç±»ã€è¤èœ/ç´ èœ/æ±¤ã€ï¼›è¦ä¹ˆå½“å‰åˆ†ç±»é‡Œæœ‰ type=è¤/ç´ /æ±¤ ä¸‰ç§ã€‚");
      return;
    }
    meat = weightedPick(byType("è¤"), prefs, pantry, avoidRecentSet);
    veg  = weightedPick(byType("ç´ "), prefs, pantry, avoidRecentSet);
    soup = weightedPick(byType("æ±¤"), prefs, pantry, avoidRecentSet);
    metaCatText = `æ¥æºï¼šå½“å‰åˆ†ç±» ${cat.name}ï¼ˆæŒ‰ type åˆ†ç»„ï¼‰`;
  }

  if(!meat || !veg || !soup){
    alert("å¥—é¤æŠ½å–å¤±è´¥ï¼šå¯èƒ½è¢«é¿é›·/æœ€è¿‘åƒè¿‡è¿‡æ»¤å®Œäº†ã€‚ä½ å¯ä»¥å…ˆé‡ç½®é¿é›·/æ¸…ç©ºæœ€è¿‘è®°å½•å†è¯•ã€‚");
    return;
  }

  const title = `è¤ï¼š${meat.name}  Â·  ç´ ï¼š${veg.name}  Â·  æ±¤ï¼š${soup.name}`;
  const tags = [...new Set([...(meat.tags||[]), ...(veg.tags||[]), ...(soup.tags||[])])];

  const meta = `æ¨¡å¼ï¼šä¸€è¤ä¸€ç´ ä¸€æ±¤ï½œ${metaCatText}ï½œé‡é€‰ï¼š${rerollCount} æ¬¡`;
  showResultCard(meta, title, tags);

  pending = {
    mode: "meal",
    items: [meat, veg, soup],
    metaText: meta
  };

  $("rerollBtn").disabled = false;
  $("confirmHint").textContent = "ç‚¹ âœ… æ‰ä¼šæŠŠä¸‰é“èœéƒ½è®°å…¥â€œæœ€è¿‘åƒè¿‡â€";
}

function confirmPending(){
  if(!pending?.items?.length){
    alert("è¿˜æ²¡æœ‰å¾…ç¡®è®¤çš„èœå•ï½");
    return;
  }
  const rec = loadRecent();

  // è®°å½•ï¼šåŒä¸€å¤©é‡å¤ç¡®è®¤åŒåèœå…è®¸ï¼Œä½†ä¼šå †ç§¯ï¼›è¿™é‡Œåšä¸ªç®€å•å»é‡ï¼ˆåŒåä¸”24hå†…ä¸é‡å¤è®°ï¼‰
  const now = Date.now();
  const recent24h = new Set(rec.filter(x=>x?.date && (now - new Date(x.date).getTime() <= 24*60*60*1000)).map(x=>x.name));

  let added = 0;
  for(const it of pending.items){
    if(!it?.name) continue;
    if(recent24h.has(it.name)) continue;
    rec.push({ name: it.name, date: todayISO() });
    added++;
  }
  saveRecent(rec);
  renderRecent();

  $("confirmHint").textContent = added ? "âœ… å·²è®°å½•ï¼ä¸‹æ¬¡ä¼šå°½é‡é¿å¼€æœ€è¿‘ 7 å¤©åƒè¿‡çš„èœ" : "å·²åœ¨ 24 å°æ—¶å†…è®°å½•è¿‡ï¼ˆæœ¬æ¬¡ä¸é‡å¤è®°ï¼‰";
}

$("rollBtn").onclick = ()=>{
  rerollCount = 0;
  rollSingle();
};

$("mealBtn").onclick = ()=>{
  rerollCount = 0;
  rollMeal();
};

$("rerollBtn").onclick = ()=>{
  rerollCount++;
  // ä¿æŒå½“å‰æ¨¡å¼é‡æŠ½
  if(pending?.mode === "meal") rollMeal();
  else rollSingle();
};

$("resetBtn").onclick = ()=>{
  rerollCount = 0;
  $("rerollBtn").disabled = true;
  hideResult();
};

$("confirmBtn").onclick = confirmPending;

$("cancelBtn").onclick = ()=>{
  $("confirmHint").textContent = "ğŸ‘Œ æ²¡è®°å…¥æœ€è¿‘åƒè¿‡ï¼ˆåªæ˜¯çœ‹çœ‹ï¼‰";
};

$("clearRecentBtn").onclick = ()=>{
  if(confirm("ç¡®å®šæ¸…ç©ºæœ¬è®¾å¤‡çš„â€œæœ€è¿‘åƒè¿‡â€è®°å½•å—ï¼Ÿ")){
    localStorage.removeItem(KEY_RECENT);
    renderRecent();
  }
};

async function init(){
  updateHints();
  renderRecent();

  try{
    const r = await fetch("./menu.json?v=" + Date.now());
    const txt = await r.text();
    const obj = JSON.parse(txt);

    // å…¼å®¹ä½ ä¹‹å‰çš„ç»“æ„ï¼šå¿…é¡»æœ‰ categories
    if(!obj || !Array.isArray(obj.categories)){
      $("status").textContent = "âŒ menu.json ç»“æ„ä¸å¯¹ï¼šéœ€è¦ { categories: [...] }";
      $("status").className = "muted";
      return;
    }
    // å…œåº• items
    obj.categories.forEach(c=>{ if(!Array.isArray(c.items)) c.items = []; });

    data = obj;
    renderCategories();
    $("status").textContent = `âœ… å·²åŠ è½½èœå•ï¼š${data.categories.length} ä¸ªåˆ†ç±»`;
  }catch(e){
    $("status").textContent = "âŒ åŠ è½½ menu.json å¤±è´¥ï¼š" + e.message;
  }
}

init();
</script>
</body>
</html>
