<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ğŸ½ï¸ ä»Šå¤©åƒä»€ä¹ˆ â€” å®¶åº­èœå•</title>
  <style>
    :root{--maxw:900px}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;max-width:var(--maxw);margin:20px auto;padding:12px;}
    header{display:flex;align-items:center;gap:12px}
    h1{margin:0;font-size:20px}
    .card{border:1px solid #eee;border-radius:12px;padding:12px;margin:12px 0;background:#fff}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    button{padding:8px 12px;border-radius:10px;border:1px solid #ddd;background:#fafafa;cursor:pointer}
    button:disabled{opacity:.5;cursor:not-allowed}
    .big{font-size:20px;font-weight:700;margin-top:8px}
    .muted{color:#666;font-size:13px}
    .tag{display:inline-block;border:1px solid #eee;border-radius:999px;padding:4px 8px;margin:4px 6px 0 0;font-size:12px;color:#555}
    #resultCard{transition:transform .12s}
    .shake{animation:shake .28s linear 1}
    @keyframes shake{0%{transform:translateX(0)}25%{transform:translateX(-6px)}50%{transform:translateX(6px)}75%{transform:translateX(-3px)}100%{transform:translateX(0)}}
    label{font-size:13px}
    input[type=text], textarea, select{padding:8px;border-radius:8px;border:1px solid #ddd;width:100%}
    .col{flex:1;min-width:160px}
    .small{font-size:13px;padding:6px;border-radius:8px}
    footer{font-size:13px;color:#666;margin-top:8px}
    .grid{display:grid;grid-template-columns:1fr 240px;gap:12px}
    @media (max-width:800px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <header>
    <h1>ğŸ½ï¸ ä»Šå¤©åƒä»€ä¹ˆ â€” å®¶åº­èœå•</h1>
    <div class="muted">ï¼ˆå·²ä¸Šçº¿ï¼‰</div>
  </header>

  <div class="grid">
    <!-- å·¦ä¾§ï¼šä¸»åŠŸèƒ½ -->
    <div>
      <div class="card">
        <div class="muted">é€‰æ‹©åˆ†ç±»ï¼ˆå…ˆç‚¹åˆ†ç±»å†æŠ½ï¼‰</div>
        <div id="catButtons" class="row" style="margin-top:8px"></div>

        <hr style="border:none;border-top:1px solid #f0f0f0;margin:12px 0">

        <div class="row" style="align-items:center">
          <button id="rollBtn">ğŸ¡ å•èœéšæœº</button>
          <button id="mealBtn">ğŸ± ä¸€è¤ä¸€ç´ ä¸€æ±¤</button>
          <button id="rerollBtn" disabled>ğŸ” ä¸æœå†æ¥ä¸€æ¬¡</button>
          <button id="resetBtn">â™»ï¸ é‡ç½®é‡é€‰</button>
          <a href="./admin.html" style="margin-left:auto">âš™ï¸ åå°åŠ èœ</a>
        </div>

        <div style="margin-top:8px" class="muted">æç¤ºï¼šæœ€å¤šé‡é€‰ 3 æ¬¡</div>
      </div>

      <div id="controls" class="card">
        <div class="row">
          <div class="col">
            <label>å¯ç”¨é£Ÿæï¼ˆç”¨é€—å·åˆ†éš”ï¼Œç³»ç»Ÿä¼šä¼˜å…ˆåŒ¹é…èœå/æ ‡ç­¾ï¼‰ï¼š</label>
            <input id="ingredientsInput" type="text" placeholder="ä¾‹å¦‚ï¼šç•ªèŒ„,é¸¡è›‹,åœŸè±†" />
          </div>
          <div style="width:140px">
            <label>å¯ç”¨æ—¶é—´</label>
            <select id="timeSelect" class="small">
              <option value="0">ä¸é™</option>
              <option value="10">â‰¤10 åˆ†é’Ÿ</option>
              <option value="20">â‰¤20 åˆ†é’Ÿ</option>
              <option value="30">â‰¤30 åˆ†é’Ÿ</option>
              <option value="60">â‰¤60 åˆ†é’Ÿ</option>
            </select>
          </div>
          <div style="width:160px">
            <label>å¨å…·é™åˆ¶ï¼ˆé€—å·åˆ†éš”ï¼‰</label>
            <input id="applianceInput" type="text" placeholder="ä¾‹å¦‚ï¼šç©ºæ°”ç‚¸é”…,ç”µé¥­ç…²" />
          </div>
        </div>

        <div style="margin-top:8px" class="muted">ç­›é€‰è¯´æ˜ï¼šå¡«å†™é£Ÿæä¼šä¼˜å…ˆåŒ¹é…åŒ…å«è¿™äº›è¯çš„èœï¼›å¨å…·/æ—¶é—´ä¼šè¿‡æ»¤ä¸æ»¡è¶³çš„èœã€‚</div>
      </div>

      <div id="resultCard" class="card" style="display:none">
        <div id="resultMeta" class="muted"></div>
        <div id="resultName" class="big"></div>
        <div id="resultTags" style="margin-top:8px"></div>
        <div id="resultExtra" class="muted" style="margin-top:8px"></div>
      </div>

      <div class="card">
        <div class="muted">æœ€è¿‘åƒè¿‡ï¼ˆæœ¬åœ°è®°å½•ï¼Œ7 å¤©å»é‡ï¼‰</div>
        <div id="recentList" style="margin-top:8px"></div>
      </div>

      <div class="card">
        <div class="muted">æ—¥å†å›é¡¾ï¼ˆé£Ÿç”¨è®°å½•ï¼‰</div>
        <div id="historyList" style="margin-top:8px"></div>
      </div>
    </div>

    <!-- å³ä¾§ï¼šåå¥½ä¸è®¾ç½® -->
    <aside>
      <div class="card">
        <div class="muted">å®¶åº­æˆå‘˜åå¥½ï¼ˆå±è”½å…³é”®å­—æˆ–ä¸åƒçš„æ ‡ç­¾/é£Ÿæï¼‰</div>
        <div id="members" style="margin-top:8px"></div>
        <div style="margin-top:8px" class="muted">æ·»åŠ æˆå‘˜åä¸é€—å·åˆ†éš”çš„ä¸åƒé¡¹ï¼ˆåå­—å’Œå…³é”®å­—ï¼‰ï¼š</div>
        <div style="margin-top:6px">
          <input id="memberName" placeholder="æˆå‘˜åï¼ˆä¾‹ï¼šçˆ¸çˆ¸ï¼‰" style="width:46%;display:inline-block" />
          <input id="memberAvoid" placeholder="ä¸åƒï¼ˆä¾‹ï¼šé¦™èœ,è¾£ï¼‰" style="width:50%;display:inline-block;margin-left:4%" />
          <div style="margin-top:6px">
            <button id="addMemberBtn">â• æ·»åŠ /æ›´æ–°æˆå‘˜</button>
            <button id="clearMembersBtn">ğŸ§¹ æ¸…ç©ºåå¥½</button>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="muted">å¿«é€Ÿæ“ä½œ</div>
        <div style="margin-top:8px" class="row">
          <button id="clearHistoryBtn">åˆ é™¤ 7 å¤©å†å²</button>
          <button id="exportHistoryBtn">å¯¼å‡ºå†å²</button>
        </div>
        <div style="margin-top:10px" class="muted">æç¤ºï¼šè‹¥æƒ³æ›´å¼ºçš„è·¨è®¾å¤‡åå°ï¼Œå¯å‡çº§åˆ° Firebaseï¼ˆå¯é€‰ï¼‰ã€‚</div>
      </div>

      <div class="card">
        <div class="muted">å°è¯´æ˜</div>
        <div class="muted" style="margin-top:8px">1) åå°åŠ èœè¯·ä½¿ç”¨ <a href="./admin.html">admin é¡µé¢</a> â†’ ä¿®æ”¹å GitHub Commit ç”Ÿæ•ˆã€‚2) æœ¬åœ°åå¥½/å†å²å­˜äºæµè§ˆå™¨ localStorageã€‚</div>
      </div>
    </aside>
  </div>

  <footer>Made for family â€” è‹¥è¦æ”¹æ ·å¼æˆ–æƒ³åŠ ç™»å½•ï¼Œæˆ‘å¯ä»¥ç»§ç»­å¸®ä½ ã€‚</footer>

<script>
/* --------------------
  åŸºæœ¬æ•°æ®åŠ è½½ä¸å…¨å±€å˜é‡
-------------------- */
let data = null;
let currentCatId = null;
let rerollCount = 0;
const MAX_REROLL = 3;
const RECENT_KEY = "family_menu_recent_v2"; // å­˜æ”¾ {name, t}
const MEMBER_KEY = "family_menu_members_v1"; // å­˜æ”¾æˆå‘˜åå¥½
const EAT_HISTORY_KEY = "family_menu_eathistory_v1"; // å­˜æ”¾æŒ‰å¤©è®°å½• {date: 'YYYY-MM-DD', items: [...]}

const $ = id => document.getElementById(id);

async function loadData(){
  try {
    const res = await fetch("./menu.json?v=" + Date.now());
    data = await res.json();
    renderCats();
    renderMembers();
    renderRecent();
    renderHistory();
  } catch(e){
    alert("åŠ è½½ menu.json å¤±è´¥ï¼Œè¯·ç¡®è®¤æ–‡ä»¶å­˜åœ¨å¹¶ä¸”æ˜¯æœ‰æ•ˆ JSONã€‚");
    console.error(e);
  }
}

/* --------------------
  åˆ†ç±»ä¸ UI
-------------------- */
function renderCats(){
  const box = $("catButtons");
  box.innerHTML = "";
  if(!data || !data.categories) return;
  data.categories.forEach(c=>{
    const btn = document.createElement("button");
    btn.textContent = c.name;
    btn.onclick = ()=>{
      currentCatId = c.id;
      Array.from(box.children).forEach(b=>b.style.borderColor="#ddd");
      btn.style.borderColor="#000";
    };
    box.appendChild(btn);
  });
}

/* --------------------
  æœ¬åœ°å†å² / å»é‡ï¼ˆ7 å¤©ï¼‰
-------------------- */
function getRecent(){ try { return JSON.parse(localStorage.getItem(RECENT_KEY) || "[]"); } catch { return []; } }
function pushRecent(name){
  const arr = getRecent();
  arr.unshift({name, t: Date.now()});
  // ä¿ç•™ 60 æ¡
  localStorage.setItem(RECENT_KEY, JSON.stringify(arr.slice(0,60)));
  // ä¹Ÿå†™è¿›æŒ‰å¤© history
  pushHistory(name);
  renderRecent();
  renderHistory();
}
function renderRecent(){
  const arr = getRecent().slice(0,20);
  $("recentList").innerHTML = arr.map(x=>{
    const d = new Date(x.t);
    return `<div>${x.name} <span class="muted">(${d.toLocaleString()})</span></div>`;
  }).join("");
}
function inLastNDays(name, days=7){
  const cutoff = Date.now() - days*24*3600*1000;
  return getRecent().some(x=>x.name===name && x.t >= cutoff);
}

/* history by day */
function pushHistory(name){
  const key = EAT_HISTORY_KEY;
  const today = new Date().toISOString().slice(0,10);
  let all = JSON.parse(localStorage.getItem(key) || "{}");
  if(!all[today]) all[today]=[];
  all[today].push({name, t: Date.now()});
  // keep 90 days
  localStorage.setItem(key, JSON.stringify(all));
}
function renderHistory(){
  const all = JSON.parse(localStorage.getItem(EAT_HISTORY_KEY) || "{}");
  const keys = Object.keys(all).sort((a,b)=>b.localeCompare(a)).slice(0,14);
  if(!keys.length){ $("historyList").innerHTML = "<div class='muted'>æš‚æ— è®°å½•</div>"; return; }
  $("historyList").innerHTML = keys.map(d=>`<div><strong>${d}</strong>ï¼š ${all[d].map(i=>i.name).join(" Â· ")}</div>`).join("");
}

/* --------------------
  æˆå‘˜åå¥½ç®¡ç†
-------------------- */
function getMembers(){ try { return JSON.parse(localStorage.getItem(MEMBER_KEY) || "[]"); } catch{ return []; } }
function saveMembers(arr){ localStorage.setItem(MEMBER_KEY, JSON.stringify(arr)); renderMembers(); }
function renderMembers(){
  const box = $("members");
  const arr = getMembers();
  if(!arr.length){ box.innerHTML = "<div class='muted'>å°šæœªæ·»åŠ æˆå‘˜åå¥½</div>"; return; }
  box.innerHTML = arr.map(m=>`<div><strong>${m.name}</strong>ï¼šä¸åƒã€${m.avoid.join('ï¼Œ')}ã€‘ <button data-name="${m.name}" class="delMember">åˆ é™¤</button></div>`).join("");
  Array.from(document.getElementsByClassName('delMember')).forEach(b=>{
    b.onclick = ()=>{ const name=b.dataset.name; const arr=getMembers().filter(x=>x.name!==name); saveMembers(arr); };
  });
}
$("addMemberBtn")?.addEventListener("click", ()=>{
  const name = $("memberName").value.trim();
  const avoid = $("memberAvoid").value.split(",").map(s=>s.trim()).filter(Boolean);
  if(!name){ alert("è¯·å¡«å†™æˆå‘˜å"); return; }
  const arr = getMembers();
  const existing = arr.find(x=>x.name===name);
  if(existing){ existing.avoid = avoid; } else arr.push({name, avoid});
  saveMembers(arr);
  $("memberName").value=""; $("memberAvoid").value="";
});
$("clearMembersBtn")?.addEventListener("click", ()=>{
  if(confirm("æ¸…ç©ºæ‰€æœ‰æˆå‘˜åå¥½ï¼Ÿ")){ localStorage.removeItem(MEMBER_KEY); renderMembers(); }
});

/* --------------------
  è¿‡æ»¤é€»è¾‘ï¼ˆé£Ÿæ/æ—¶é—´/å¨å…·/æˆå‘˜åå¥½/7å¤©å»é‡ï¼‰
-------------------- */
function itemMatchesFilters(item){
  // æ—¶é—´
  const maxTime = parseInt($("timeSelect").value || "0", 10);
  if(maxTime>0 && item.time && item.time>0 && item.time>maxTime) return false;

  // å¨å…·
  const appliances = ($("applianceInput").value || "").split(",").map(s=>s.trim().toLowerCase()).filter(Boolean);
  if(appliances.length && item.tags){
    // å¦‚æœç”¨æˆ·åªè¾“å…¥äº†ç‰¹å®šå¨å…·ï¼Œä½†èœçš„ tags æ²¡æœ‰è¯¥å¨å…·ï¼Œåˆ™æ’é™¤ï¼ˆä¾‹å¦‚ç”¨æˆ·åªæœ‰ç©ºæ°”ç‚¸é”…ï¼‰
    // æ”¾å®½é€»è¾‘ï¼šå¦‚æœèœæ ‡æ³¨äº†ä»»ä½•å¨å…·ä¸”å…¶ä¸­ä¸åŒ…å«ç”¨æˆ·æŒ‡å®šçš„ä»»æ„ä¸€ä¸ªï¼Œåˆ™è®¤ä¸ºä¸åŒ¹é…
    const tagLow = (item.tags||[]).map(t=>t.toLowerCase());
    const anyMatch = appliances.some(a=> tagLow.includes(a));
    if(!anyMatch) return false;
  }

  // æˆå‘˜åå¥½ï¼ˆä¸åƒå…³é”®å­—/æ ‡ç­¾ï¼‰
  const members = getMembers();
  if(members.length){
    for(const m of members){
      for(const avoid of m.avoid){
        const av = avoid.toLowerCase();
        if(!av) continue;
        if((item.name||"").toLowerCase().includes(av)) return false;
        if((item.tags||[]).map(t=>t.toLowerCase()).includes(av)) return false;
      }
    }
  }

  // æœ€è¿‘ 7 å¤©ä¸é‡å¤ï¼šå®Œå…¨æ’é™¤
  if(inLastNDays(item.name, 7)) return false;

  return true;
}

/* --------------------
  éšæœºé€‰æ‹©é€»è¾‘
-------------------- */
function pickOneFromPool(pool){
  if(!pool.length) return null;
  return pool[Math.floor(Math.random()*pool.length)];
}

function filterByIngredientsAndTime(items){
  const ingredients = ($("ingredientsInput").value || "").split(",").map(s=>s.trim().toLowerCase()).filter(Boolean);
  if(!ingredients.length) return items.filter(itemMatchesFilters);
  // ä¼˜å…ˆé€‰åŒ…å«ä»»ä¸€ ingredient çš„èœï¼ˆåœ¨ name æˆ– tagsï¼‰
  const match = items.filter(i=>{
    const nameLow = (i.name||"").toLowerCase();
    const tagLow = (i.tags||[]).map(t=>t.toLowerCase());
    return ingredients.some(ins => nameLow.includes(ins) || tagLow.includes(ins));
  }).filter(itemMatchesFilters);
  const fallback = items.filter(itemMatchesFilters);
  return match.length ? match : fallback;
}

/* å•èœéšæœºï¼ˆrollï¼‰ */
function rollSingle(){
  if(!currentCatId){ alert("å…ˆé€‰ä¸ªåˆ†ç±»ï½"); return; }
  const cat = data.categories.find(c=>c.id===currentCatId);
  if(!cat || !cat.items?.length){ alert("è¿™ä¸ªåˆ†ç±»è¿˜æ²¡èœï¼Œå»åå°åŠ ç‚¹å§ï½"); return; }
  rerollCount = 0;
  const pool = filterByIngredientsAndTime(cat.items);
  const pick = pickOneFromPool(pool);
  if(!pick){ alert("æ²¡æœ‰æ»¡è¶³ç­›é€‰æ¡ä»¶çš„èœï¼ˆè¯·è°ƒæ•´æ—¶é—´/å¨å…·/é£Ÿææˆ–æ£€æŸ¥æˆå‘˜åå¥½ï¼‰"); return; }
  showResult(pick, cat.name);
  $("rerollBtn").disabled = false;
}

function showResult(item, catName){
  $("resultCard").style.display = "block";
  $("resultMeta").textContent = `åˆ†ç±»ï¼š${catName} ï½œ å•èœæ¨¡å¼ ï½œ é‡é€‰ ${rerollCount} æ¬¡`;
  $("resultName").textContent = item.name;
  $("resultTags").innerHTML = (item.tags||[]).map(t=>`<span class="tag">${t}</span>`).join("");
  $("resultExtra").textContent = `é¢„è®¡ç”¨æ—¶ï¼š${item.time||"â€”"} åˆ†é’Ÿï¼Œéš¾åº¦ï¼š${item.difficulty||"â€”"}`;
  animateResult();
  pushRecent(item.name);
}

/* å¥—é¤é€»è¾‘ï¼šä¸€è¤ä¸€ç´ ä¸€æ±¤ */
function pickByType(items, type){
  const pool = items.filter(x => ((x.type||"").toLowerCase() === type.toLowerCase()));
  const filtered = filterByIngredientsAndTime(pool);
  return pickOneFromPool(filtered || []);
}
function rollMeal(){
  if(!currentCatId){ alert("å…ˆé€‰ä¸ªåˆ†ç±»ï½"); return; }
  const cat = data.categories.find(c=>c.id===currentCatId);
  if(!cat || !cat.items?.length){ alert("è¿™ä¸ªåˆ†ç±»è¿˜æ²¡èœï¼Œå»åå°åŠ ç‚¹å§ï½"); return; }
  rerollCount = 0;
  const meat = pickByType(cat.items, "è¤");
  const veg  = pickByType(cat.items, "ç´ ");
  const soup = pickByType(cat.items, "æ±¤");
  if(!meat || !veg || !soup){
    alert("å½“å‰åˆ†ç±»éœ€è‡³å°‘å„æœ‰ï¼šè¤ / ç´  / æ±¤ å„ 1 é“ï¼ˆè¯·åœ¨ admin æ·»åŠ  type å­—æ®µï¼‰");
    return;
  }
  // æ˜¾ç¤ºå¥—é¤
  $("resultCard").style.display = "block";
  $("resultMeta").textContent = `åˆ†ç±»ï¼š${cat.name} ï½œ å¥—é¤æ¨¡å¼ ï½œ é‡é€‰ ${rerollCount} æ¬¡`;
  $("resultName").textContent = `è¤ï¼š${meat.name}  Â·  ç´ ï¼š${veg.name}  Â·  æ±¤ï¼š${soup.name}`;
  const tags = [...new Set([...(meat.tags||[]), ...(veg.tags||[]), ...(soup.tags||[])])];
  $("resultTags").innerHTML = tags.map(t=>`<span class="tag">${t}</span>`).join("");
  $("resultExtra").textContent = `æ—¶é—´ï¼š${(meat.time||"â€”")} / ${(veg.time||"â€”")} / ${(soup.time||"â€”")} åˆ†é’Ÿ`;
  animateResult();
  [meat, veg, soup].forEach(i=>pushRecent(i.name));
  $("rerollBtn").disabled = false;
}

/* åŠ¨ç”» */
function animateResult(){
  $("resultCard").classList.remove("shake");
  void $("resultCard").offsetWidth;
  $("resultCard").classList.add("shake");
}

/* reroll */
$("rollBtn").onclick = ()=>{ rerollCount = 0; rollSingle(); };
$("mealBtn").onclick = ()=>{ rerollCount = 0; rollMeal(); };
$("rerollBtn").onclick = ()=>{
  rerollCount++;
  if(rerollCount > MAX_REROLL){ alert("åˆ«çº ç»“äº†ï¼Œæ”¶æ‰‹å§ ğŸ˜¤"); rerollCount = MAX_REROLL; return; }
  // æ ¹æ®ä¸Šä¸€æ¬¡ result æ¨¡å¼é‡æŠ½ï¼ˆç®€å•æ–¹æ³•ï¼šå¦‚æœ resultName å« 'ï¼š' åˆ™æ˜¯å¥—é¤ï¼‰
  const meta = $("resultMeta").textContent || "";
  if(meta.includes("å¥—é¤")) rollMeal(); else rollSingle();
};
$("resetBtn").onclick = ()=>{ rerollCount=0; alert("å·²é‡ç½®é‡é€‰æ¬¡æ•°"); };

/* å¿«é€Ÿæ“ä½œ */
$("clearHistoryBtn").onclick = ()=>{ if(confirm("åˆ é™¤æœ€è¿‘è®°å½•ï¼ˆ7 å¤©å†å²ï¼‰ï¼Ÿ")){ localStorage.removeItem(RECENT_KEY); localStorage.removeItem(EAT_HISTORY_KEY); renderRecent(); renderHistory(); } };
$("exportHistoryBtn").onclick = ()=>{ const all = localStorage.getItem(EAT_HISTORY_KEY)||"{}"; navigator.clipboard.writeText(all).then(()=>alert("å·²å¤åˆ¶å†å² JSON åˆ°å‰ªè´´æ¿")); };

/* åˆå§‹åŒ– */
loadData();

/* render members on load already handled */

/* small helpers for admin/debug */
window._debug_reload = loadData;
</script>
</body>
</html>

