<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ğŸ½ï¸ ä»Šå¤©åƒä»€ä¹ˆ</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;max-width:980px;margin:24px auto;padding:0 14px}
    h1{margin:6px 0 10px}
    .muted{color:#666;font-size:13px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    button{padding:10px 14px;border-radius:14px;border:1px solid #ddd;background:#fff;cursor:pointer}
    button.primary{background:#111;color:#fff;border-color:#111}
    button[disabled]{opacity:.45}
    input{border:1px solid #ddd;border-radius:12px;padding:10px 12px}
    .card{border:1px solid #e6e6e6;border-radius:18px;padding:16px;margin:12px 0}
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{padding:8px 12px;border-radius:999px;border:1px solid #e6e6e6;cursor:pointer}
    .chip.active{background:#111;color:#fff;border-color:#111}
    .tag{display:inline-block;border:1px solid #eee;border-radius:999px;padding:4px 10px;font-size:12px;margin-right:6px;margin-top:6px}
    .big{font-size:22px;font-weight:700}
    .pill{display:inline-block;border:1px solid #eee;border-radius:999px;padding:4px 10px;font-size:12px;background:#fafafa}
  </style>
</head>
<body>

<div class="row" style="justify-content:space-between">
  <h1>ğŸ½ï¸ ä»Šå¤©åƒä»€ä¹ˆ</h1>
  <a href="./admin.html">åå° â†’</a>
</div>

<p class="muted" id="status">åŠ è½½ä¸­â€¦</p>

<!-- åˆ†ç±» -->
<div class="card">
  <h3>é€‰æ‹©åˆ†ç±»</h3>
  <div class="chips" id="cats"></div>
</div>

<!-- å†°ç®±åæ¨çŠ¶æ€ -->
<div class="card">
  <h3>ğŸ¥¬ å†°ç®±åæ¨</h3>
  <p class="muted" id="pantryStatus">æœªè®¾ç½®</p>
</div>

<!-- æŠ½å– -->
<div class="card">
  <div class="row">
    <button class="primary" id="rollBtn">ğŸ¡ å•èœ</button>
    <button id="mealBtn">ğŸ± ä¸€è¤ä¸€ç´ ä¸€æ±¤</button>
    <button id="rerollBtn" disabled>ä¸æœå†æ¥ä¸€æ¬¡</button>
  </div>

  <div id="resultCard" class="card" style="display:none;margin-top:12px">
    <div class="muted" id="resultMeta"></div>
    <div class="big" id="resultName"></div>
    <div id="resultTags"></div>
  </div>
</div>

<script>
const $ = id => document.getElementById(id);

const KEY_PANTRY = "family_menu_pantry_v2";

let data=null, currentCatId=null;

/* ---------- å†°ç®± ---------- */
function loadPantry(){
  try{
    return JSON.parse(localStorage.getItem(KEY_PANTRY)) || { items:[], mode:"suggest" };
  }catch{
    return { items:[], mode:"suggest" };
  }
}

function pantryMatches(item, pantry){
  if(!pantry.items.length) return false;
  return pantry.items.some(f =>
    item.name.includes(f) ||
    (item.tags||[]).includes(f)
  );
}

/* ---------- æŠ½å– ---------- */
function pickItem(items){
  const pantry = loadPantry();
  let pool = items;

  if(pantry.mode === "strict"){
    pool = items.filter(it => pantryMatches(it, pantry));
    if(!pool.length) return null;
  }

  return pool[Math.floor(Math.random()*pool.length)];
}

/* ---------- å•èœ ---------- */
function rollSingle(){
  const cat = data.categories.find(c=>c.id===currentCatId);
  const pick = pickItem(cat.items);
  if(!pick){
    alert("âŒ å†°ç®±é‡Œçš„é£Ÿææš‚æ—¶åšä¸äº†è¿™ä¸ªåˆ†ç±»çš„èœ");
    return;
  }
  showResult(`å•èœï½œ${cat.name}`, pick.name, pick.tags);
}

/* ---------- å¥—é¤ ---------- */
function rollMeal(){
  const pantry = loadPantry();
  const m = data.categories.find(c=>c.id==="meat");
  const v = data.categories.find(c=>c.id==="veg");
  const s = data.categories.find(c=>c.id==="soup");

  if(!m||!v||!s){ alert("éœ€è¦ è¤ / ç´  / æ±¤ åˆ†ç±»"); return; }

  const a = pickItem(m.items);
  const b = pickItem(v.items);
  const c = pickItem(s.items);

  if(!a||!b||!c){
    alert("âŒ å†°ç®±é‡Œçš„é£Ÿææš‚æ—¶æ— æ³•ç»„æˆä¸€è¤ä¸€ç´ ä¸€æ±¤");
    return;
  }

  showResult(
    "ä¸€è¤ä¸€ç´ ä¸€æ±¤",
    `è¤ï¼š${a.name} Â· ç´ ï¼š${b.name} Â· æ±¤ï¼š${c.name}`,
    [...new Set([...(a.tags||[]),...(b.tags||[]),...(c.tags||[])])]
  );
}

/* ---------- æ˜¾ç¤º ---------- */
function showResult(meta,name,tags){
  $("resultCard").style.display="block";
  $("resultMeta").textContent=meta;
  $("resultName").textContent=name;
  $("resultTags").innerHTML=(tags||[]).map(t=>`<span class="tag">${t}</span>`).join("");
}

/* ---------- åˆå§‹åŒ– ---------- */
fetch("./menu.json")
  .then(r=>r.json())
  .then(j=>{
    data=j;
    $("status").textContent="èœå•å·²åŠ è½½";
    const cats=$("cats");
    j.categories.forEach((c,i)=>{
      const d=document.createElement("div");
      d.className="chip"+(i===0?" active":"");
      d.textContent=c.name;
      d.onclick=()=>{
        currentCatId=c.id;
        [...cats.children].forEach(x=>x.classList.remove("active"));
        d.classList.add("active");
      };
      cats.appendChild(d);
      if(i===0) currentCatId=c.id;
    });
  });

const pantry = loadPantry();
$("pantryStatus").textContent =
  pantry.items.length
    ? `æ¨¡å¼ï¼š${pantry.mode==="strict"?"ä¸¥æ ¼åæ¨":"æ¨è"} ï½œ é£Ÿæï¼š${pantry.items.join("ã€")}`
    : "æœªè®¾ç½®ï¼ˆå»åå°é…ç½®ï¼‰";

$("rollBtn").onclick = rollSingle;
$("mealBtn").onclick = rollMeal;
</script>

</body>
</html>
